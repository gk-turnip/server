{{define "head"}}
<head>
	<title>{{.Title}}</title>
	<meta http-equiv="content-type" 
		content="text/html;charset=utf-8" />

	<link rel="stylesheet" type="text/css" 
		href="{{.WebAddressPrefix}}/assets/gk/stylesheets/game/game.css"/>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkRain.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkIso.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkWs.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkAudio.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkTerrain.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkField.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkDispatch.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkView.js" type="text/javascript"></script>

	<script type="text/javascript">
		var loaded;
		var mode;
		function init() {
			console.log("calling init");

			scriptUse = document.getElementById("scriptUse");
			var loader = document.createTextNode("Loaded!");
			var loaded = scriptUse.appendChild(loader);
			var loader;
			
			var s1
			s1 = document.getElementById("selectAvatar");
			s1.selectedIndex = 0;
			s1 = document.getElementById("volume1");
			s1.selectedIndex = 1;
			s1 = document.getElementById("volume2");
			s1.selectedIndex = 1;

			gkWsInit(gkDispatchWsMessage, "{{.WebsocketAddressPrefix}}", "{{.WebsocketPath}}", "{{.SessionId}}");

			gkRainStart();

			gkAudioInit("{{.AudioAddressPrefix}}");
			var canPlay = document.getElementById("canPlay");
			if (gkAudioContext.canPlayWav) {
				canPlay.innerHTML += " .wav";
			}
			if (gkAudioContext.canPlayMp3) {
				canPlay.innerHTML += " .mp3";
			}
			if (gkAudioContext.canPlayOgg) {
				canPlay.innerHTML += " .ogg";
			}
			gkAudioStartAudio(1, "Underwater2");
			gkAudioStartAudio(3, "Rain");
			var rainTBP = document.getElementById("audio3");
			rainTBP.pause();
			var rainTBP;

			gkTerrainInit(5);
			//gkAvatarInit();
			gkFieldInit();

			setValue("zoomValue",gkViewContext.scale);
			setValue("svgWidthValue",gkViewContext.svgWidth);
			setValue("svgHeightValue",gkViewContext.svgHeight);
		}

		function doClick(e) {
			var x, y

			x = e.pageX;
			y = e.pageY;

//			x = e.pageX - GK_SVG_MARGIN_X;
//			y = e.pageY - GK_SVG_MARGIN_Y;
//
//			var winXY;
//
//			winXY = new GkWinXYDef(x,y);
//			//gkAvatarSetNewDestination(winXY.convertToIso(0));

			var isoXYZ = gkViewConvertWinToIso(x,gkViewContext.marginX,y,gkViewContext.marginY, 0);
			var g = gkIsoCreateSingleDiamond(isoXYZ, "#00ff00", 0.5);
			var objectLayer = document.getElementById("gkTerrainObjectLayer");
			objectLayer.appendChild(g);

			gkFieldSetNewAvatarDestination(winXY.convertToIso(0));

			gkAudioStartAudio(2, "boing");
		}

		function changeAvatar() {
			avatarName = document.getElementById("selectAvatar").value;
			console.log("avatarName: " + avatarName)
			//gkAvatarLoadNewAvatar(avatarName);
			gkFieldLoadNewAvatar(avatarName);
		}

		function volumeChange(volumeId) {
			volumeSelect = document.getElementById("volume" + volumeId);
			value = volumeSelect.options[volumeSelect.selectedIndex].value
			gkAudioVolumeChange(volumeId, value);
		}

		function doSubmit() {
			var inputText = document.getElementById("chatInput");
			var message = inputText.value;
			gkWsSendMessage("chatReq~{ \"userName\": \"" + gkWsContext.userName + "\", \"message\": \"" + message + "\" }~");

			inputText.value = "";
			return false;
		}

		function doSubmitSkip() {
			return false;
		}

		function doZoomChange(change) {
			gkViewContext.scale += change;
			if (gkViewContext.scale > 2.0) {
				gkViewContext.scale = 2.0;
			}
			if (gkViewContext.scale < 0.5) {
				gkViewContext.scale = 0.5;
			}
			gkViewContext.scale = Math.round(gkViewContext.scale * 10) / 10;
			setValue("zoomValue",gkViewContext.scale);
			gkViewRender();
		}

		function doSvgWidthChange(change) {
			gkViewContext.svgWidth += change;
			setValue("svgWidthValue",gkViewContext.svgWidth);
			gkViewRender();
		}

		function doSvgHeightChange(change) {
			gkViewContext.svgHeight += change;
			setValue("svgHeightValue",gkViewContext.svgHeight);
			gkViewRender();
		}

		function setValue(id, value) {
			var v = document.getElementById(id)
			v.innerHTML = value
		}

		function doKeyDown(event) {
			if (event.keyCode == 37) {
				event.preventDefault();
				gkFieldSetLeftKeyDown();
			}
			if (event.keyCode == 39) {
				event.preventDefault();
				gkFieldSetRightKeyDown();
			}
			if (event.keyCode == 38) {
				event.preventDefault();
				gkFieldSetUpKeyDown();
			}
			if (event.keyCode == 40) {
				event.preventDefault();
				gkFieldSetDownKeyDown();
			}
		}

		function doKeyUp(event) {
			
			if (event.keyCode == 37) {

				gkFieldSetLeftKeyUp();
			}
			if (event.keyCode == 39) {
				gkFieldSetRightKeyUp();
			}
			if (event.keyCode == 38) {
				gkFieldSetUpKeyUp();
			}
			if (event.keyCode == 40) {
				gkFieldSetDownKeyUp();
			}
		}

		window.addEventListener('keydown', doKeyDown);
		window.addEventListener('keyup', doKeyUp);

	</script>
</head>
{{end}}
