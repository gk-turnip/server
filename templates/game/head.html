{{define "head"}}
<head>
	<title>{{.Title}}</title>
	<meta http-equiv="content-type" 
		content="text/html;charset=utf-8" />

	<link rel="stylesheet" type="text/css" 
		href="/assets/gk/stylesheets/game/game.css" title="default"/>

	<link rel="alternate stylesheet" type="text/css" 
		href="/assets/gk/stylesheets/game/game_thin.css" title="thin"/>
	<link rel="alternate stylesheet" type="text/css" 
		href="/assets/gk/stylesheets/game/game_normal.css" title="normal"/>
	<link rel="alternate stylesheet" type="text/css" 
		href="/assets/gk/stylesheets/game/game_wide.css" title="wide"/>

	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/dynamiclayout.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkRain.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkIso.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkWs.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkAudio.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkTerrain.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkField.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkDispatch.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkView.js" type="text/javascript"></script>
	<script src="{{.WebAddressPrefix}}/assets/gk/javascript/game/gkChat.js" type="text/javascript"></script>

	<script type="text/javascript">
		var loaded;
		var mode;
		function init() {
			console.log("calling init");
			loadCache();
			scriptUse = document.getElementById("scriptUse");
			var loader = document.createTextNode("Loaded!");
			var loaded = scriptUse.appendChild(loader);
			var loader;

			gkChatInit();
			
			var s1
			s1 = document.getElementById("selectAvatar");
			s1.selectedIndex = 0;
			s1 = document.getElementById("volume1");
			s1.selectedIndex = 1;
			s1 = document.getElementById("volume2");
			s1.selectedIndex = 1;

			gkWsInit(gkDispatchWsMessage, "{{.WebsocketAddressPrefix}}", "{{.WebsocketPath}}", "{{.SessionId}}");

			gkRainStart();

			gkAudioInit("{{.AudioAddressPrefix}}");
			var canPlay = document.getElementById("canPlay");
			if (gkAudioContext.canPlayWav) {
				canPlay.innerHTML += " .wav";
			}
			if (gkAudioContext.canPlayMp3) {
				canPlay.innerHTML += " .mp3";
			}
			if (gkAudioContext.canPlayOgg) {
				canPlay.innerHTML += " .ogg";
			}
			gkAudioStartAudio(1, "Underwater2", true);
			gkAudioStartAudio(3, "Rain", true);
			var rainTBP = document.getElementById("audio3");
			rainTBP.pause();
			var rainTBP;

			gkTerrainInit(5);
			//gkAvatarInit();
			gkFieldInit();
			setValue("zoomValue",gkViewContext.scale);

			var svgWidthInput = document.getElementById("svgWidthInput");
			var svgHeightInput = document.getElementById("svgHeightInput");
			svgWidthInput.value = gkViewContext.svgWidth;
			svgHeightInput.value = gkViewContext.svgHeight;
			doSvgWidthHeightChange();
		}
		
		function loadCache() {
			console.log("Loading cache");
			if (JSON.stringify(localStorage) != "{}") {
				try {
					for (var i=1;i<5;i++) {
						var volumeSelect = document.getElementById("volume" + i);
						if (parseFloat(localStorage.gk.volume[i]) != NaN) {
							volumeSelect.value = parseFloat(localStorage.gk.volume[i]);
							volumeChange(i);
						}
					}
					var avatarName = document.getElementById("selectAvatar");
					if (localStorage.gk.avatarName) {
						avatarName.value = localStorage.gk.avatarName;
						changeAvatar();
					} else {
						console.warn("cache: no avatar");
					}
					var sW = document.getElementById("svgWidthInput");
					var sH = document.getElementById("svgHeightInput");
					if ((parseInt(localStorage.gk.field.width) != NaN) && (parseInt(localStorage.gk.field.height) != NaN)) {
						sW.value = parseInt(localStorage.gk.field.width);
						sH.value = parseInt(localStorage.gk.field.height);
						doSvgWidthHeightChange();
					} else {
						console.warn("cache: no height/width");
						sW.value = gkViewContext.svgWidth;
						sH.value = gkViewContext.svgHeight;
						doSvgWidthHeightChange();
					}
					if (parseFloat(localStorage.gk.field.zoom) != NaN) {
						setValue("zoomValue", parseFloat(localStorage.gk.field.zoom));
						doZoomChange(parseFloat(localStorage.gk.field.zoom) - 1.0);
					} else {
						console.warn("cache: no zoom");
						setValue("zoomValue",gkViewContext.scale);
					}
				} catch {
					console.error("Something went wrong. Rebuilding cache.")
					buildCache();
				}
			} else {
				console.warn("No local cache. Is this the first run?");
				buildCache();
			}
		}

		function buildCache() {
			localStorage.gk = new Object();
			localStorage.gk.field = new Object();
			localStorage.gk.volume = new Array();
			console.log("cache built");
		}
		function doClick(e) {
			gkFieldHandleFieldClick(e.pageX, e.pageY);
//			console.log("doClick");
//			var x, y
//
//			x = e.pageX;
//			y = e.pageY;
//
//			var isoXYZ = gkViewConvertWinToIso(x,gkViewContext.marginX,y,gkViewContext.marginY, 0);
//			var g = gkIsoCreateSingleDiamond(isoXYZ, "#00ff00", 0.5);
//
//			gkFieldSetNewAvatarDestination(winXY.convertToIso(0));
//
//			gkAudioStartAudio(2, "boing", false);
//
//			gkTerrainClearMoveMarker();
//			gkTerrainSetMoveMarker(g);
		}

//		function svgObjectClick(id, x, y, z, originX, originY) {
//			console.log("svgObjectClick id: " + id + " xyz: " + x + "," + y + "," + z + " origin: " + originX + "," + originY);
//		}

		function changeAvatar() {
			avatarName = document.getElementById("selectAvatar").value;
			console.log("avatarName: " + avatarName)
			//gkAvatarLoadNewAvatar(avatarName);
			gkFieldLoadNewAvatar(avatarName);
			localStorage.gk.avatarName = avatarName;
		}

		function volumeChange(volumeId) {
			volumeSelect = document.getElementById("volume" + volumeId);
			value = volumeSelect.options[volumeSelect.selectedIndex].value
			gkAudioVolumeChange(volumeId, value);
			localStorage.gk.volume[volumeId] = value;
		}

/*
		function doSubmitChat() {
			var inputText = document.getElementById("chatInput");
			var message = inputText.value.replace("~",".");

			var jsonMessage = JSON.stringify({ userName: gkWsContext.userName, message: message });
			if (message.length > 0) {
				gkWsSendMessage("chatReq~" + jsonMessage + "~");
			}

			inputText.value = "";
			return false;
		}
*/

		function doSvgWidthHeightChange() {
			var svgWidth = parseInt(document.getElementById("svgWidthInput").value);
			var svgHeight = parseInt(document.getElementById("svgHeightInput").value);
			var spacer = document.getElementById("svgSpacer");

			if (svgWidth < 120) {
				svgWidth = 120;
			}
			if (svgHeight < 120) {
				svgHeight = 120;
			}
			var x = window.innerWidth - svgWidth
			if (x > 0) {
				spacer.left = svgWidth;
				spacer.width = x;
			}
			spacer.height = svgHeight
			
			gkViewContext.svgWidth = svgWidth;
			gkViewContext.svgHeight = svgHeight;
			gkViewRender();
			localStorage.gk.field.width = svgWidth;
			localStorage.gk.field.height = svgHeight;
		}

		function doSubmitControls() {
			return false;
		}

		function doZoomChange(change) {
			gkViewContext.scale += change;
			if (gkViewContext.scale > 2.0) {
				gkViewContext.scale = 2.0;
			}
			if (gkViewContext.scale < 0.5) {
				gkViewContext.scale = 0.5;
			}
			gkViewContext.scale = Math.round(gkViewContext.scale * 10) / 10;
			setValue("zoomValue",gkViewContext.scale);
			gkViewRender();
			localStorage.gk.field.zoom = gkViewContext.scale;
		}

		function setValue(id, value) {
			var v = document.getElementById(id)
			v.innerHTML = value
		}

		function doKeyDown(event) {
			if (event.keyCode == 37) {
				gkFieldSetLeftKeyDown();
			}
			if (event.keyCode == 39) {
				gkFieldSetRightKeyDown();
			}
			if (event.keyCode == 38) {
				gkFieldSetUpKeyDown();
			}
			if (event.keyCode == 40) {
				gkFieldSetDownKeyDown();
			}
		}

		function doKeyUp(event) {
			if (event.keyCode == 37) {
				gkFieldSetLeftKeyUp();
			}
			if (event.keyCode == 39) {
				gkFieldSetRightKeyUp();
			}
			if (event.keyCode == 38) {
				gkFieldSetUpKeyUp();
			}
			if (event.keyCode == 40) {
				gkFieldSetDownKeyUp();
			}
		}
		function nothing() {
		}
		function setRainStatus() {
			var rs = document.getElementById("rainswitcher");
			gkRainContext.override = rs.checked;
			return false;
		}
	</script>
</head>
{{end}}
